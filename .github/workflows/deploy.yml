name: Deploy to DigitalOcean

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          script: |
            cd /opt/nutrimind
            git pull origin main
            docker compose up --build -d
            # Wait for container to be ready
            sleep 5
            # Re-register webhook with self-signed cert (required for IP-based HTTPS)
            curl -s -F "url=https://${{ secrets.DROPLET_IP }}:8443/webhook/telegram" \
                 -F "certificate=@/opt/nutrimind/certs/cert.pem" \
                 -F 'allowed_updates=["message"]' \
                 https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/setWebhook
            echo ""
            echo "âœ… Deployed at $(date)"
